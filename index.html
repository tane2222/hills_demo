<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãŠå£ã®å¥åº·è¨ºæ–­</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* --- Modern & Simple Dental Design --- */
    :root {
      --primary: #00BFA5; /* æ¸…æ½”æ„Ÿã®ã‚ã‚‹ãƒ†ã‚£ãƒ¼ãƒ«ã‚°ãƒªãƒ¼ãƒ³ */
      --primary-dark: #009688;
      --accent: #FFAB40; /* æŸ”ã‚‰ã‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ï¼‰ */
      --bg: #F7F9FA;
      --text: #333333;
      --text-light: #777777;
      --white: #ffffff;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }

    /* Cards */
    .card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
      transition: transform 0.2s;
    }

    h1 { font-size: 1.5rem; text-align: center; color: var(--primary-dark); margin-bottom: 20px; }
    h2 { font-size: 1.2rem; margin-bottom: 10px; }
    p { font-size: 0.95rem; color: var(--text-light); }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      margin-top: 10px;
      transition: background 0.2s;
    }
    .btn-primary { background-color: var(--primary); color: white; }
    .btn-primary:active { background-color: var(--primary-dark); }
    .btn-option { 
      background-color: var(--bg); 
      color: var(--text); 
      text-align: left; 
      border: 1px solid #eee;
    }
    .btn-option.selected {
      background-color: #E0F2F1; /* è–„ã„ã‚°ãƒªãƒ¼ãƒ³ */
      border-color: var(--primary);
      color: var(--primary-dark);
    }

    /* Menu Grid */
    .menu-grid { display: grid; gap: 15px; }
    .menu-item {
      cursor: pointer;
      text-align: center;
      padding: 25px 15px;
    }
    .menu-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }

    /* Steps & Progress */
    .hidden { display: none; }
    .step-indicator { text-align: right; font-size: 0.8rem; color: var(--primary); margin-bottom: 5px; }

    /* Loading Spinner */
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin: 30px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="view-menu">
    <h1>ãŠå£ã®å¥åº·è¨ºæ–­</h1>
    <p style="text-align:center; margin-bottom:20px;">æ°—ã«ãªã‚‹é …ç›®ã‚’é¸ã‚“ã§ãã ã•ã„</p>
    
    <div class="menu-grid">
      <div class="card menu-item" onclick="startDiagnosis('periodontal')">
        <span class="menu-icon">ğŸ¦·</span>
        <h2>æ­¯å‘¨ç—…ãƒªã‚¹ã‚¯</h2>
        <p>æ­¯èŒã®è…«ã‚Œãƒ»å‡ºè¡€ãªã©</p>
      </div>
      
      <div class="card menu-item" onclick="startDiagnosis('aesthetic')">
        <span class="menu-icon">âœ¨</span>
        <h2>å¯©ç¾ãƒ»è¦‹ãŸç›®</h2>
        <p>é»„ã°ã¿ãƒ»æ­¯ä¸¦ã³ãªã©</p>
      </div>

      <div class="card menu-item" onclick="startDiagnosis('child')">
        <span class="menu-icon">ğŸ‘¶</span>
        <h2>ãŠå­æ§˜ãƒã‚§ãƒƒã‚¯</h2>
        <p>è™«æ­¯ãƒªã‚¹ã‚¯ãƒ»ç¿’æ…£</p>
      </div>
    </div>
  </div>

  <div id="view-question" class="hidden">
    <div class="card">
      <div class="step-indicator">Q <span id="q-current">1</span> / <span id="q-total">5</span></div>
      <h2 id="q-text">è³ªå•ãƒ†ã‚­ã‚¹ãƒˆ</h2>
      <div id="q-options">
        </div>
    </div>
  </div>

  <div id="view-result" class="hidden">
    <div class="card" style="text-align:center;">
      <h2 id="result-title">è¨ºæ–­ä¸­...</h2>
      <div id="loading-spinner" class="spinner"></div>
      <p id="result-msg">çµæœã‚’è§£æã—ã¦ã„ã¾ã™ã€‚</p>
      <button id="btn-close" class="btn btn-primary hidden" onclick="liff.closeWindow()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script>
  // --- Configuration: è³ªå•ãƒ‡ãƒ¼ã‚¿ ---
  const QUESTIONS = {
    periodontal: [
      { id: 'q1', text: 'æ­¯ç£¨ãã®æ™‚ã€å‡ºè¡€ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', options: [{label:'ã‚ˆãã‚ã‚‹', score:3}, {label:'ãŸã¾ã«ã‚ã‚‹', score:1}, {label:'ãªã„', score:0}] },
      { id: 'q2', text: 'æœèµ·ããŸæ™‚ã€å£ã®ä¸­ãŒãƒãƒãƒãƒã—ã¾ã™ã‹ï¼Ÿ', options: [{label:'ã¯ã„', score:2}, {label:'ã„ã„ãˆ', score:0}] },
      { id: 'q3', text: 'æ­¯ãŒé•·ããªã£ãŸï¼ˆæ­¯èŒãŒä¸‹ãŒã£ãŸï¼‰æ°—ãŒã—ã¾ã™ã‹ï¼Ÿ', options: [{label:'ã¯ã„', score:3}, {label:'ã„ã„ãˆ', score:0}] },
      { id: 'q4', text: 'å£è‡­ã‚’æŒ‡æ‘˜ã•ã‚ŒãŸã€ã¾ãŸã¯æ°—ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ', options: [{label:'ã¯ã„', score:2}, {label:'ã„ã„ãˆ', score:0}] }
    ],
    aesthetic: [
      { id: 'q1', text: 'æœ€ã‚‚æ°—ã«ãªã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ', options: [{label:'æ­¯ã®è‰²ãƒ»é»„ã°ã¿', score:0}, {label:'æ­¯ä¸¦ã³', score:0}, {label:'éŠ€æ­¯ã‚’ç™½ãã—ãŸã„', score:0}] },
      { id: 'q2', text: 'ã„ã¤ã¾ã§ã«æ²»ã—ãŸã„ã§ã™ã‹ï¼Ÿ', options: [{label:'ã§ãã‚‹ã ã‘æ—©ã', score:2}, {label:'åŠå¹´ä»¥å†…', score:1}, {label:'ç‰¹ã«æ±ºã¾ã£ã¦ãªã„', score:0}] },
      { id: 'q3', text: 'äººå‰ã§ç¬‘ã†æ™‚ã€å£å…ƒã‚’æ‰‹ã§éš ã—ã¦ã—ã¾ã„ã¾ã™ã‹ï¼Ÿ', options: [{label:'ã¯ã„', score:3}, {label:'ã„ã„ãˆ', score:0}] }
    ],
    child: [
      { id: 'q1', text: 'ãŠã‚„ã¤ï¼ˆã‚¢ãƒ¡ã‚„ã‚¸ãƒ¥ãƒ¼ã‚¹å«ã‚€ï¼‰ã‚’1æ—¥ä½•å›ã¨ã‚Šã¾ã™ã‹ï¼Ÿ', options: [{label:'3å›ä»¥ä¸Š', score:3}, {label:'2å›', score:1}, {label:'1å›ä»¥ä¸‹', score:0}] },
      { id: 'q2', text: 'ä»•ä¸Šã’ç£¨ãã¯æ¯æ—¥ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ', options: [{label:'æ¯æ—¥ã—ã¦ã„ã‚‹', score:0}, {label:'æ™‚ã€…å¿˜ã‚Œã‚‹', score:2}, {label:'ã—ã¦ã„ãªã„', score:5}] },
      { id: 'q3', text: 'ãƒ•ãƒƒç´ å¡—å¸ƒã‚’ã—ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', options: [{label:'å®šæœŸçš„ã«ã—ã¦ã„ã‚‹', score:0}, {label:'æ˜”ã—ãŸã“ã¨ãŒã‚ã‚‹', score:1}, {label:'ãªã„', score:3}] }
    ]
  };

  // --- State ---
  let currentType = '';
  let currentQIndex = 0;
  let totalScore = 0;
  let answers = {};
  let userProfile = null;

  // --- Initialize ---
  // â˜…ã“ã“ã«LIFF IDã‚’å…¥ã‚Œã¦ãã ã•ã„
  const LIFF_ID = '2008709251-eFKUYcgF'; 
  // â˜…GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’å…¥ã‚Œã¦ãã ã•ã„
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbw1wYTnO7uSsxeGiLnLcT0k1cZvZmXAGICCMICoYgIK-A3NfbCQSJcO2F_zmD9IeEChvA/exec';

  async function initLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (liff.isLoggedIn()) {
        userProfile = await liff.getProfile();
      } else {
        liff.login();
      }
    } catch (err) {
      console.error('LIFF Init Error', err);
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼
      userProfile = { userId: 'dummy', displayName: 'Guest' }; 
    }
  }
  initLiff();

  // --- UI Functions ---
  function switchView(viewId) {
    document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(viewId).classList.remove('hidden');
  }

  function startDiagnosis(type) {
    currentType = type;
    currentQIndex = 0;
    totalScore = 0;
    answers = {};
    renderQuestion();
    switchView('view-question');
  }

  function renderQuestion() {
    const qList = QUESTIONS[currentType];
    const q = qList[currentQIndex];

    document.getElementById('q-current').innerText = currentQIndex + 1;
    document.getElementById('q-total').innerText = qList.length;
    document.getElementById('q-text').innerText = q.text;

    const optionsDiv = document.getElementById('q-options');
    optionsDiv.innerHTML = '';

    q.options.forEach((opt, idx) => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-option';
      btn.innerText = opt.label;
      btn.onclick = () => handleAnswer(q.id, opt.label, opt.score);
      optionsDiv.appendChild(btn);
    });
  }

  function handleAnswer(qId, label, score) {
    // Save Answer
    answers[qId] = label;
    totalScore += score;

    // Next or Finish
    const qList = QUESTIONS[currentType];
    if (currentQIndex < qList.length - 1) {
      currentQIndex++;
      renderQuestion();
    } else {
      submitDiagnosis();
    }
  }

  // --- API ---
  async function submitDiagnosis() {
    switchView('view-result');
    
    const payload = {
      userId: userProfile ? userProfile.userId : 'unknown',
      displayName: userProfile ? userProfile.displayName : 'Guest',
      type: currentType,
      score: totalScore,
      answers: answers
    };

    try {
      // Send to GAS
      await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // GAS do not support application/json in CORS well
        body: JSON.stringify(payload)
      });

      // Show Success
      document.getElementById('loading-spinner').classList.add('hidden');
      document.getElementById('result-title').innerText = 'è¨ºæ–­å®Œäº†';
      document.getElementById('result-msg').innerText = 'çµæœã‚’LINEã«ãŠé€ã‚Šã—ã¾ã—ãŸã€‚\nãƒˆãƒ¼ã‚¯ç”»é¢ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
      document.getElementById('btn-close').classList.remove('hidden');

      // Send simple message in chat on behalf of user (optional)
      // if (liff.isInClient()) {
      //   liff.sendMessages([{ type: 'text', text: 'è¨ºæ–­ã‚’è¡Œã„ã¾ã—ãŸ' }]);
      // }

    } catch (err) {
      document.getElementById('result-title').innerText = 'ã‚¨ãƒ©ãƒ¼';
      document.getElementById('result-msg').innerText = 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      console.error(err);
    }
  }
</script>
</body>
</html>
